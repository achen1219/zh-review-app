// generate_data.js
const fetch = require('node-fetch'); // v2 版
const fs    = require('fs');

// ←── 在這裡填入你的 API key ──→
const apiKey = 'ca3c6b07-0e0e-4774-a57d-6d0bb178801d';

////////////////////////////////////////////////////////////////////////////////
// 1) 讀 schedule.js 裡的排程
//    你也可以直接把 schedule.js 的物件複製到這裡
const schedule = {
  "2025-05-07": ["腰","蓋","初","夏","省","桐","包","類","資","影","敦","爾","悟","拆"],
  "2025-05-08": ["取","抬","腰","蓋","初","夏","技","票","周","例","擁","擠","盛","隨"]
};
// 將所有字匯集成一個不重複陣列
const chars = Array.from(new Set(Object.values(schedule).flat()));

// 2) 一一向 API 請求
async function fetchChar(ch) {
  const url = `https://pedia.cloud.edu.tw/api/v1/character/${encodeURIComponent(ch)}?api_key=${apiKey}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const js = await res.json();
  return {
    bopomofo:    js.bopomofo        || js.pinyin_bopomofo || '',
    phrases2:    js.phrases_2       || [],
    phrases3:    js.phrases_3       || [],
    phrase4:     (js.collocations_4 && js.collocations_4[0]) || '',
    definition:  (js.definitions   && js.definitions[0])    || '',
    example:     (js.examples      && js.examples[0])       || ''
  };
}

(async () => {
  const details = {};
  for (const ch of chars) {
    try {
      const d = await fetchChar(ch);
      details[ch] = { char: ch, ...d };
      console.log(`Fetched: ${ch}`);
    } catch (e) {
      console.error(`Error fetching ${ch}:`, e.message);
      details[ch] = { char: ch, bopomofo:'', phrases2:[], phrases3:[], phrase4:'', definition:'', example:'' };
    }
  }

  // 3) 寫入 data.js
  const out = 
    '// THIS FILE IS AUTO-GENERATED by generate_data.js\n' +
    'const charDetails = ' + JSON.stringify(details, null, 2) + ';\n' +
    'export default charDetails;\n';
  fs.writeFileSync('data.js', out, 'utf-8');
  console.log('✓ data.js generated successfully');
})();
