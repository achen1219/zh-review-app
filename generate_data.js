// generate_data.js
// Run: node generate_data.js
const fetch = require('node-fetch');
const fs    = require('fs');

// â† YOUR API KEY HERE â†“
const apiKey = 'ca3c6b07-0e0e-4774-a57d-6d0bb178801d';

// 1) Your daily schedule:
const schedule = {
  "2025-05-07": ["è…°","è“‹","åˆ","å¤","çœ","æ¡","åŒ…","é¡","è³‡","å½±","æ•¦","çˆ¾","æ‚Ÿ","æ‹†"],
  "2025-05-08": ["å–","æŠ¬","è…°","è“‹","åˆ","å¤","æŠ€","ç¥¨","å‘¨","ä¾‹","æ“","æ“ ","ç››","éš¨"]
};
// flatten + dedupe:
const chars = Array.from(new Set(Object.values(schedule).flat()));

async function fetchDetail(ch) {
  const url = `https://pedia.cloud.edu.tw/api/v2/Detail?term=${encodeURIComponent(ch)}&api_key=${apiKey}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  
  // get the full JSON
  const json = await res.json();

  // sometimes the API nests the payload under "data", sometimes directly at top level
  const d = json.data || json;

  return {
    bopomofo:    d.bopomofo    || d.pinyin_bopomofo || '',
    definitions: d.definitions || (d.definition ? [d.definition] : []),
    examples:    d.examples    || [],
    phrases2:    d.phrases_2   || [],
    phrases3:    d.phrases_3   || [],
    phrases4:    d.collocations_4 || []
  };
}

(async () => {
  const details = {};
  for (const ch of chars) {
    try {
      const d = await fetchDetail(ch);
      details[ch] = { char: ch, ...d };
      console.log(`âœ…  Fetched ${ch}`);
    } catch (e) {
      console.warn(`âš ï¸  Failed ${ch}: ${e.message}`);
      details[ch] = { char:ch, bopomofo:'', definitions:[], examples:[], phrases2:[], phrases3:[], phrases4:[] };
    }
  }

  // 3) Write out data.js
  const out = [
    '// AUTO-GENERATED by generate_data.js',
    'export default ',
    JSON.stringify(details, null, 2),
    ';'
  ].join('\n');
  fs.writeFileSync('data.js', out, 'utf-8');
  console.log(`ğŸ‰ data.js written with ${Object.keys(details).length} entries`);
})();
