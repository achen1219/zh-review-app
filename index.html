<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>æ¯æ—¥è¤‡ç¿’</title>
  <style>
    body { font-family: 'Microsoft JhengHei', sans-serif; padding: 20px; }
    h1, h2 { color: #333; }
    .flashcard { 
      border:1px solid #ccc; padding:10px; margin:10px 0; border-radius:5px; 
      max-width:360px;
    }
    .char { font-size:24px; display:inline-block; width:50px; }
    select, button { font-size:16px; margin-top:8px; }
    #points { margin-top:15px; font-weight:bold; }
    #result { margin-top:10px; }
  </style>
</head>
<body>

  <h1>ğŸ“… æ¯æ—¥è¤‡ç¿’</h1>

  <!-- æ—¥æœŸé¸å–® -->
  <label for="date-selector">é¸æ“‡æ—¥æœŸï¼š</label>
  <select id="date-selector"></select>

  <!-- ç”Ÿå­—å¡ç‰‡ -->
  <h2>ğŸ”– ç”Ÿå­—å¡ç‰‡</h2>
  <div id="flashcards">è¼‰å…¥ä¸­â€¦</div>

  <!-- éŠæˆ²1ï¼šå­—ç¾©é…å° -->
  <h2>ğŸ® éŠæˆ²1ï¼šå­—ç¾©é…å°</h2>
  <div id="points">ç©åˆ†: 0</div>
  <div id="game1"></div>
  <button id="submitBtn" onclick="checkAnswers()">æäº¤</button>
  <div id="result"></div>

  <!-- è¼‰å…¥ schedule -->
  <script src="schedule.js"></script>
  <script>
    const apiKey = 'ca3c6b07-0e0e-4774-a57d-6d0bb178801d';
    const dateSel   = document.getElementById('date-selector');
    const flashDiv  = document.getElementById('flashcards');
    const gameDiv   = document.getElementById('game1');
    const ptsDiv    = document.getElementById('points');
    const resDiv    = document.getElementById('result');
    const submitBtn = document.getElementById('submitBtn');

    // è®€æœ¬åœ°åˆ†æ•¸
    let points = Number(localStorage.getItem('zhReviewPoints')||0);
    function updatePts() {
      ptsDiv.textContent = 'ç©åˆ†: ' + points;
    }
    function savePts() {
      localStorage.setItem('zhReviewPoints', points);
    }

    // å¡«æ—¥æœŸä¸‹æ‹‰
    Object.keys(schedule).forEach(date=>{
      let o = document.createElement('option');
      o.value = o.textContent = date;
      dateSel.appendChild(o);
    });
    dateSel.addEventListener('change', ()=> renderFor(dateSel.value) );

    // ä¸»æ¸²æŸ“å‡½å¼
    async function renderFor(date) {
      flashDiv.innerHTML = 'è¼‰å…¥ä¸­â€¦';
      gameDiv .innerHTML = '';
      resDiv  .innerHTML = '';
      submitBtn.disabled = false;
      updatePts();

      const chars = schedule[date];
      // 1. å–å¾—æ‰€æœ‰å­—çš„è©³ç´°è³‡æ–™
      const details = await Promise.all(chars.map(fetchCharDetail));

      // 2. ç”¢ç”Ÿç”Ÿå­—å¡ç‰‡
      flashDiv.innerHTML = '';
      details.forEach(d => {
        const card = document.createElement('div');
        card.className = 'flashcard';
        card.innerHTML = `
          <h2>${d.char}</h2>
          <button onclick="play('${d.char}')">ğŸ”Š ç™¼éŸ³</button>
          <p>æ³¨éŸ³ï¼š${d.bopomofo}</p>
          <p>äºŒå­—ï¼š${d.phrases2.join('ã€')}</p>
          <p>ä¸‰å­—ï¼š${d.phrases3.join('ã€')}</p>
          <p>å››å­—ï¼š${d.phrases4 || ''}</p>
          <p>å®šç¾©ï¼š${d.definition}</p>
          <p>ä¾‹å¥ï¼š${d.exampleSentence}</p>
        `;
        flashDiv.appendChild(card);
      });

      // 3. ç”¢ç”Ÿé…å°éŠæˆ²
      gameDiv.innerHTML = '';
      details.forEach(d => {
        const row = document.createElement('div');
        row.className = 'item';
        // ç‚ºäº†ç¤ºç¯„ï¼ŒéŒ¯èª¤é¸é …éš¨æ©Ÿå–å…¶ä»–ä¸€å€‹å­—çš„å®šç¾©
        const other = details.find(x=>x.char!==d.char);
        row.innerHTML = `
          <span class="char">${d.char}</span>
          <select data-answer="${d.definition}">
            <option value="">-- é¸æ“‡ å®šç¾© --</option>
            <option>${d.definition}</option>
            <option>${other.definition}</option>
          </select>
        `;
        gameDiv.appendChild(row);
      });
    }

    // å‘¼å« API æ‹¿å­—è©³ç´°
    async function fetchCharDetail(ch) {
      const url = `https://pedia.cloud.edu.tw/api/v1/character/${encodeURIComponent(ch)}?api_key=${apiKey}`;
      const res = await fetch(url);
      const js  = await res.json();
      return {
        char: ch,
        bopomofo: js.bopomofo || js.pinyin_bopomofo || '',
        phrases2: js.phrases_2 || [],
        phrases3: js.phrases_3 || [],
        phrases4: (js.collocations_4 && js.collocations_4[0]) || '',
        definition: (js.definitions && js.definitions[0]) || '',
        exampleSentence: (js.examples && js.examples[0]) || ''
      };
    }

    // ç™¼éŸ³
    function play(ch) {
      const u = new SpeechSynthesisUtterance(ch);
      u.lang = 'zh-TW';
      speechSynthesis.speak(u);
    }

    // æª¢æŸ¥ç­”æ¡ˆ
    function checkAnswers() {
      const sels = document.querySelectorAll('#game1 select');
      let ok=0;
      sels.forEach(s=>{
        if(s.value===s.getAttribute('data-answer')) ok++;
        s.disabled=true;
      });
      const earn = ok * 5;
      points += earn; savePts(); updatePts();
      submitBtn.disabled = true;
      resDiv.textContent = ok===sels.length
        ? `ğŸ‘ å…¨éƒ¨ç­”å°ï¼ +${earn} åˆ†`
        : `âŒ ç­”å° ${ok}/${sels.length} é¡Œï¼Œ+${earn} åˆ†`;
    }

    // åˆæ¬¡è¼‰å…¥
    dateSel.value = Object.keys(schedule)[0];
    renderFor(dateSel.value);
  </script>
</body>
</html>
